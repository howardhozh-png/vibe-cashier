<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Cashier Demo - Vibe Coffee</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <style>
        /* --- General Styling --- */
        :root {
            --primary-color: #38a166; /* Updated Green */
            --secondary-color: #00e077; /* New Bright Green/Teal */
            --bg-color: #f7fafc;
            --card-bg: #ffffff;
            --text-color: #2d3748;
            --border-color: #f2d374; /* Adjusted border color to be valid hex */
            --font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            font-family: var(--font-family);
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
        }

        header {
            background-color: var(--primary-color);
            color: white;
            padding: 1rem 2rem;
            text-align: center;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 1rem;
            display: flex;
            gap: 2rem;
        }

        .view-section {
            background-color: var(--card-bg);
            border-radius: 8px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            padding: 1.5rem;
            flex-grow: 1;
        }

        h2 {
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 0.5rem;
            margin-top: 0;
            color: var(--primary-color);
        }

        /* --- Tab Navigation --- */
        .tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 2rem;
            gap: 1rem;
        }

        .tab-button {
            background-color: var(--border-color);
            color: var(--text-color);
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
            font-weight: bold;
        }

        .tab-button.active {
            background-color: var(--primary-color);
            color: white;
        }

        /* --- 1. Customer View --- */
        #customer-view {
            width: 35%;
            min-height: 70vh;
            display: flex;
            flex-direction: column;
        }

        #chat-interface {
            flex-grow: 1;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 1rem;
            margin-bottom: 1rem;
            overflow-y: auto;
            max-height: 50vh;
            background-color: #fefefe;
        }

        .message {
            margin-bottom: 10px;
            max-width: 80%;
            padding: 8px 12px;
            border-radius: 15px;
            line-height: 1.4;
        }

        .user-message {
            background-color: var(--primary-color);
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 0;
        }

        .ai-message {
            background-color: var(--border-color);
            color: var(--text-color);
            margin-right: auto;
            border-bottom-left-radius: 0;
        }
        
        .notification-message {
            background-color: var(--secondary-color); /* Use bright secondary color for notification */
            color: var(--text-color);
            margin: 10px auto;
            border-radius: 8px;
            font-weight: bold;
        }

        .receipt {
            border: 1px dashed var(--primary-color);
            padding: 10px;
            margin-top: 15px;
            background-color: #ebfbee; /* Lightened background based on new primary color */
            font-size: 0.9rem;
            text-align: center; /* Center the receipt content */
        }
        
        #qrcode {
            margin: 10px auto 10px auto;
            padding: 5px;
            border: 1px solid var(--border-color);
            display: inline-block;
        }

        .input-controls {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        #text-input {
            flex-grow: 1;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 4px;
        }

        #send-btn, #voice-toggle {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 0.75rem 1rem;
            border-radius: 4px;
            cursor: pointer;
        }
        
        #voice-toggle.voice-active {
            background-color: #ef4444; /* Red for recording */
        }

        /* --- 2. Barista View --- */
        #barista-view {
            width: 30%;
        }

        .order-ticket {
            border: 1px solid var(--border-color);
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 4px;
            background-color: #f7fbfd;
        }

        .ticket-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
            font-weight: bold;
        }

        .status-tag {
            padding: 4px 8px;
            border-radius: 3px;
            font-size: 0.8rem;
            color: white;
        }

        .status-pending { background-color: #3182ce; }
        .status-in-progress { background-color: #f6ad55; }
        .status-completed { background-color: var(--primary-color); }

        .ticket-details {
            list-style: none;
            padding: 0;
            margin: 0.5rem 0;
        }

        .ticket-details li {
            margin-bottom: 3px;
            font-size: 0.95rem;
        }

        .ticket-actions button {
            background-color: var(--secondary-color);
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 0.5rem;
            font-weight: bold;
        }

        /* --- 3. Owner View --- */
        #owner-view {
            width: 35%;
        }

        .metric-card {
            padding: 1.5rem;
            margin-bottom: 1rem;
            border-radius: 8px;
            background-color: #ebfbee; /* Lightened background based on new primary color */
            border-left: 5px solid var(--primary-color);
        }

        .metric-card h3 {
            margin-top: 0;
            color: var(--primary-color);
            font-size: 1.1rem;
        }

        .metric-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--text-color);
        }

        #top-selling-list {
            list-style: decimal;
            padding-left: 1.5rem;
        }

        #top-selling-list li {
            padding: 5px 0;
            border-bottom: 1px dotted var(--border-color);
        }

        /* --- Utility Class --- */
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>

    <header>
        <h1>â˜• Vibe AI Cashier</h1>
        <p>A Mini-Product Demo</p>
    </header>

    <div class="tabs">
        <button class="tab-button active" data-view="customer">Customer View</button>
        <button class="tab-button" data-view="barista">Barista View</button>
        <button class="tab-button" data-view="owner">Owner View</button>
    </div>

    <div class="container">
        <section id="customer-view" class="view-section">
            <h2>Customer View: Order Now</h2>
            <p><strong>Note:</strong> Voice logic is implemented via an **ElevenLabs Agent Placeholder**.</p>

            <div id="chat-interface">
                <div class="message ai-message">
                    Hi there! Welcome to NYC Coffee. What can I get started for you today?
                </div>
            </div>

            <div class="input-controls">
                <input type="text" id="text-input" placeholder="Type your order (e.g., 'I want a large hot latte with oat milk and a pump of hazelnut')">
                <button id="send-btn">Send</button>
                <button id="voice-toggle">ðŸŽ¤ Activate ElevenLabs Agent</button>
            </div>
            <p id="voice-status" style="margin-top: 0.5rem; font-size: 0.85rem; color: #ef4444;" class="hidden">
                VOICE MODE: The ElevenLabs Agent would now handle the full conversation (STT/LLM/TTS) and call the 'placeOrder' function when ready.
            </p>

        </section>

        <section id="barista-view" class="view-section hidden">
            <h2>Barista View: Active Orders</h2>
            <div id="order-queue">
                <p id="no-orders" style="color: #90a4ae;">No active orders yet. Vibe check: PASSED (for now!)</p>
            </div>
        </section>

        <section id="owner-view" class="view-section hidden">
            <h2>Owner View: Daily Data Dashboard</h2>
            <div id="dashboard-metrics">
                <div class="metric-card">
                    <h3>Total Orders Today</h3>
                    <div id="metric-total-orders" class="metric-value">0</div>
                </div>
                <div class="metric-card">
                    <h3>Average Order Value (AOV)</h3>
                    <div id="metric-aov" class="metric-value">$0.00</div>
                </div>
                <div class="metric-card">
                    <h3>Total Revenue</h3>
                    <div id="metric-revenue" class="metric-value">$0.00</div>
                </div>
                <div class="metric-card">
                    <h3>Top Selling Item</h3>
                    <div id="metric-top-item" class="metric-value">N/A</div>
                </div>
            </div>

            <h3 style="margin-top: 2rem;">Top 3 Items Sold</h3>
            <ol id="top-selling-list">
                </ol>
        </section>
    </div>

    <script>
        // --- âš™ï¸ CONFIGURATION: GOOGLE SHEET API URL ---
        // FINAL WORKING URL FROM PREVIOUS STEPS
        const GOOGLE_SHEET_API_URL = 'https://script.google.com/a/macros/wondersco.com/s/AKfycbzXvx_TuYLaqgYpF3_lnP1C7Nh6YY7YbU-4KIzV0CzEMVqbq3tVrUydwgVEagfwd0K/exec';
        // ----------------------------------------------------

        // --- â˜• Data & Menu (Matches NYC Coffee Menu) ---
        let orders = JSON.parse(localStorage.getItem('vibeCoffeeOrders')) || [];
        let orderIdCounter = localStorage.getItem('vibeOrderIdCounter') || 1001;
        
        // State for Multi-turn Conversation (DEPRECATED: Replaced by ElevenLabs Agent)
        let currentOrder = null;
        let conversationState = 'initial';
        let currentClarifyingMod = null;
        let currentItemDetails = null;

        const MENU = {
            // --- COFFEE ---
            'americano': { 
                category: 'Espresso', 
                prices: { 'small': 3.00, 'large': 4.00 }, 
                options: ['size', 'temp', 'shots'] 
            },
            'latte': { 
                category: 'Espresso', 
                prices: { 'small': 4.00, 'large': 5.00 }, 
                options: ['size', 'temp', 'milk', 'shots', 'syrup'] 
            },
            'cold brew': { 
                category: 'Cold', 
                prices: { 'small': 4.00, 'large': 5.00 }, 
                options: ['size', 'ice', 'milk', 'sweetness'] 
            },
            'mocha': { 
                category: 'Espresso', 
                prices: { 'small': 4.50, 'large': 5.50 }, 
                options: ['size', 'temp', 'milk', 'shots', 'syrup'] 
            },
            'coffee frappuccino': { 
                category: 'Blended', 
                prices: { 'small': 5.50, 'large': 6.00 }, 
                options: ['size', 'milk', 'sweetness'] 
            },
            // --- TEA ---
            'black tea': { 
                category: 'Tea', 
                prices: { 'small': 3.00, 'large': 3.75 }, 
                options: ['size', 'temp', 'sweetness'] 
            },
            'jasmine tea': { 
                category: 'Tea', 
                prices: { 'small': 3.50, 'large': 4.25 }, 
                options: ['size', 'temp', 'sweetness'] 
            },
            'lemon green tea': { 
                category: 'Tea', 
                prices: { 'small': 3.50, 'large': 4.25 }, 
                options: ['size', 'temp', 'sweetness'] 
            },
            'matcha latte': { 
                category: 'Tea', 
                prices: { 'small': 4.50, 'large': 5.25 }, 
                options: ['size', 'temp', 'milk', 'matcha'] 
            }
        };

        const MODIFIERS = {
            'size': { default: 'small', options: ['small', 'large'], keywords: ['small', 'large', '12oz', '16oz'] },
            'temp': { default: 'hot', options: ['hot', 'iced'], keywords: ['hot', 'iced', 'cold'] },
            'milk': { 
                default: 'whole milk', 
                prices: { 'whole milk': 0.00, 'skim milk': 0.00, 'oat milk': 0.50, 'almond milk': 0.75 },
                keywords: ['whole milk', 'skim milk', 'oat milk', 'almond milk', 'oat', 'almond', 'skim']
            },
            'ice': { 
                default: 'regular', 
                options: ['no ice', 'less ice', 'regular'],
                keywords: ['no ice', 'less ice', 'regular ice']
            },
            'shots': { default: 1, prices: { 'extra espresso shot': 1.50 }, keywords: ['extra shot', '2 shots', 'two shots', 'add shot'] }, 
            'matcha': { default: 0, prices: { 'extra matcha shot': 1.50 }, keywords: ['extra matcha', 'add matcha', '2 matcha'] }, 
            'sweetness': { 
                default: 'regular', 
                options: ['no sugar', 'less sugar', 'extra sugar', 'regular'], 
                keywords: ['no sugar', 'less sugar', 'extra sugar', 'unsweetened']
            },
            'syrup': { 
                default: 'none', 
                prices: { 'caramel syrup': 0.50, 'hazelnut syrup': 0.50 },
                keywords: ['caramel', 'hazelnut']
            },
        };

        const ClarificationMap = {
            'size': {
                question: "What size would you like? We have Small (12oz) and Large (16oz).",
                regex: /(small|12oz|large|16oz)/i,
                parse: (msg) => msg.includes('large') || msg.includes('16oz') ? 'large' : 'small'
            },
            'temp': {
                question: "Would you like that Hot or Iced?",
                regex: /(hot|iced|cold)/i,
                parse: (msg) => msg.includes('iced') || msg.includes('cold') ? 'iced' : 'hot'
            },
            'milk': {
                question: "What kind of milk? We have Whole, Skim, Oat (+\\$0.50), or Almond (+\\$0.75).",
                regex: /(whole milk|skim milk|oat milk|almond milk|oat|almond|skim|whole)/i,
                parse: (msg) => {
                    if (msg.includes('oat')) return 'oat milk';
                    if (msg.includes('almond')) return 'almond milk';
                    if (msg.includes('skim')) return 'skim milk';
                    return 'whole milk';
                }
            },
            'sweetness': {
                question: "And for sweetness? Regular, Less Sugar, Extra Sugar, or No Sugar?",
                regex: /(no sugar|less sugar|extra sugar|regular|unsweetened)/i,
                parse: (msg) => {
                    if (msg.includes('no sugar') || msg.includes('unsweetened')) return 'no sugar';
                    if (msg.includes('less sugar')) return 'less sugar';
                    if (msg.includes('extra sugar')) return 'extra sugar';
                    return 'regular';
                }
            },
            'ice': {
                question: "What level of ice? Regular, Less Ice, or No Ice?",
                regex: /(no ice|less ice|regular ice|regular)/i,
                parse: (msg) => {
                    if (msg.includes('no ice')) return 'no ice';
                    if (msg.includes('less ice')) return 'less ice';
                    return 'regular';
                }
            },
            'syrup': {
                question: "Would you like to add Caramel or Hazelnut syrup? (+\\$0.50)",
                regex: /(caramel|hazelnut|no|none)/i,
                parse: (msg) => {
                    if (msg.includes('caramel')) return 'caramel syrup';
                    if (msg.includes('hazelnut')) return 'hazelnut syrup';
                    return 'none';
                }
            }
        };

        function generateOrderId() {
            const id = `VIBE-${orderIdCounter}`;
            orderIdCounter++;
            localStorage.setItem('vibeOrderIdCounter', orderIdCounter);
            return id;
        }

        function calculatePrice(itemKey, mods) {
            const sizeKey = mods.size;
            let price = MENU[itemKey].prices[sizeKey] || 0.00; 
            
            if (mods.milk && mods.milk !== MODIFIERS.milk.default) {
                 price += MODIFIERS.milk.prices[mods.milk] || 0;
            }

            if (mods.shots > 1) { 
                price += MODIFIERS.shots.prices['extra espresso shot'];
            }

            if (mods.matcha > 0) {
                 price += MODIFIERS.matcha.prices['extra matcha shot'] * mods.matcha;
            }

            if (mods.syrup && mods.syrup !== MODIFIERS.syrup.default) {
                price += MODIFIERS.syrup.prices[mods.syrup] || 0;
            }

            return price.toFixed(2);
        }

        function checkImpossibleRequests(item) {
            if (item.name.includes('frappuccino') && item.mods.temp === 'hot') {
                return "Frappuccinos are blended drinks, so they can only be served cold/iced.";
            }

            if (item.name === 'cold brew' && item.mods.temp === 'hot') {
                 return "Cold Brew is brewed cold and can only be served iced.";
            }

            if (item.name === 'latte' && item.mods.shots < 1) {
                return "A Latte must have espresso. Did you mean to order a Milk/Steamer?";
            }
            
            if (item.mods.shots > 5) {
                item.mods.shots = 5; 
                return "For safety, we cap espresso at 5 shots per drink. I've added 5 for you.";
            }
            
            const baseMilk = MODIFIERS.milk.default;
            if (item.name.includes('tea') && !item.name.includes('latte') && item.mods.milk !== baseMilk) {
                 return "Only Matcha Latte supports milk substitutions. Your other teas will be made with water/tea base.";
            }

            return null;
        }

        // --- DEPRECATED FUNCTION (Now a DEMO Fallback) ---
        // This function now primarily handles the demo flow when the ElevenLabs SDK is not live.
        function processUserMessage(message) {
            const lowerMsg = message.toLowerCase();
            const response = { type: 'chat', text: '' };

            if (lowerMsg.includes('latte') || lowerMsg.includes('mocha') || lowerMsg.includes('coffee')) {
                response.text = "Thank you. In a live version, the AI Agent would take this input and begin the clarification process now (size, temp, milk, etc.). Say 'checkout' to bypass and see the receipt.";
                return response;
            }

            if (lowerMsg.includes('checkout')) {
                 // Simulate a successful order fulfillment by the AI Agent
                 const simulatedOrder = {
                    id: generateOrderId(), 
                    status: 'Pending', 
                    items: [{
                        name: 'latte', 
                        price: 5.00,
                        mods: { size: 'large', temp: 'hot', milk: 'oat milk', shots: 1, matcha: 0, ice: 'regular', sweetness: 'regular', syrup: 'hazelnut syrup' }
                    }]
                };

                // Manually calculate price for the receipt
                simulatedOrder.items[0].price = calculatePrice(simulatedOrder.items[0].name, simulatedOrder.items[0].mods);

                response.type = 'receipt';
                response.text = 'Perfect! The AI Agent has finalized your simulated order. Scan the QR code below to save it.';
                placeOrder(simulatedOrder);
                return response;
            }

            response.text = "I'm sorry, I didn't recognize that. Please try a drink name or say 'checkout'.";
            return response;
        }

        // --- DOM Elements ---
        const chatInterface = document.getElementById('chat-interface');
        const textInput = document.getElementById('text-input');
        const sendBtn = document.getElementById('send-btn');
        const voiceToggle = document.getElementById('voice-toggle');
        const voiceStatus = document.getElementById('voice-status');
        const orderQueue = document.getElementById('order-queue');
        const noOrdersMessage = document.getElementById('no-orders');

        // --- 1. Customer View Functions ---

        function renderMessage(text, type, data = null) {
            const msgDiv = document.createElement('div');
            msgDiv.classList.add('message');
            if (type === 'notification') {
                msgDiv.classList.add('notification-message');
            } else {
                msgDiv.classList.add(`${type}-message`);
            }
            msgDiv.innerHTML = text;

            if (type === 'receipt' && data) {
                msgDiv.innerHTML += renderReceipt(data);
                
                setTimeout(() => {
                    const qrCodeElement = document.getElementById(`qrcode-${data.id}`);
                    if (qrCodeElement) {
                        const receiptLink = `https://vibe.coffee/receipt?id=${data.id}&total=${data.total}`;
                        new QRCode(qrCodeElement, {
                            text: receiptLink,
                            width: 100,
                            height: 100,
                            colorDark : "#38a166",
                            colorLight : "#ffffff",
                            correctLevel : QRCode.CorrectLevel.H
                        });
                    }
                }, 50);
            }

            chatInterface.appendChild(msgDiv);
            chatInterface.scrollTop = chatInterface.scrollHeight;
        }

        function renderReceipt(order) {
            let total = 0;
            let receiptHTML = `<div class="receipt">
                <p style="text-align: center; font-weight: bold;">Order Receipt #${order.id}</p>
                <hr style="border-style: dotted;">`;
            
            order.items.forEach(item => {
                const itemTotal = parseFloat(item.price);
                total += itemTotal;
                
                let modsList = [
                    `Size: ${item.mods.size.toUpperCase()}`,
                    `Temp: ${item.mods.temp.toUpperCase()}`,
                    `Milk: ${item.mods.milk.toUpperCase()}`
                ];
                
                if (item.mods.shots > 1) { modsList.push(`Extra Espresso Shot`); }
                if (item.mods.matcha > 0) { modsList.push(`Extra Matcha Shot`); }
                if (item.mods.syrup !== MODIFIERS.syrup.default) { modsList.push(`Syrup: ${item.mods.syrup.toUpperCase()}`); }
                if (item.mods.ice !== MODIFIERS.ice.default) { modsList.push(`Ice: ${item.mods.ice.toUpperCase()}`); }
                if (item.mods.sweetness !== MODIFIERS.sweetness.default) { modsList.push(`Sugar: ${item.mods.sweetness.toUpperCase()}`); }


                receiptHTML += `<p style="margin-bottom: 0;"><strong>${item.name.toUpperCase()}</strong> - $${itemTotal.toFixed(2)}</p>
                    <ul style="list-style: none; margin: 0; padding: 0 0 5px 10px; font-size: 0.85rem; text-align: left;">
                        ${modsList.map(mod => `<li>- ${mod}</li>`).join('')}
                    </ul>`;
            });

            receiptHTML += `<hr style="border-style: dotted;">
                <p style="font-weight: bold; font-size: 1.1rem; text-align: right; margin-right: 15px;">TOTAL: $${total.toFixed(2)}</p>
                
                <p style="font-size: 0.8rem; margin-top: 15px; margin-bottom: 5px;">Scan to keep your receipt:</p>
                <div id="qrcode-${order.id}" style="width:100px; height:100px; margin: 0 auto;"></div>
                
                <p style="text-align: center; margin-top: 10px;">Thank you! Your order is being prepared.</p>
            </div>`;
            return receiptHTML;
        }

        function placeOrder(order) {
            const finalOrder = { 
                ...order, 
                timestamp: new Date().toISOString(),
                total: order.items.reduce((sum, item) => sum + parseFloat(item.price), 0).toFixed(2)
            };
            
            fetch(GOOGLE_SHEET_API_URL, {
                method: 'POST',
                mode: 'no-cors',
                cache: 'no-cache',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(finalOrder)
            })
            .then(response => { console.log('Order data sent to Google Sheet API.'); })
            .catch(error => console.error('Error sending order data:', error));


            orders.unshift(finalOrder);
            saveOrders();
            renderBaristaView();
            renderOwnerView();
        }

        // Event listener for Send button
        sendBtn.addEventListener('click', () => {
            const message = textInput.value.trim();
            if (message === '') return;
            
            renderMessage(message, 'user');
            textInput.value = '';

            setTimeout(() => {
                const response = processUserMessage(message);
                if (response.type === 'receipt') {
                    const placedOrder = orders[0];
                    renderMessage(response.text, 'ai', placedOrder);
                } else {
                    renderMessage(response.text, 'ai');
                }
            }, 500);
        });

        // Event listener for Voice Toggle (LIVE INTEGRATION PATH)
        let elevenLabsAgent = null; // Placeholder for the actual SDK object
        let isVoiceActive = false;

        voiceToggle.addEventListener('click', () => {
            isVoiceActive = !isVoiceActive;
            voiceToggle.classList.toggle('voice-active', isVoiceActive);
            
            if (isVoiceActive) {
                // 1. Update UI for Active State
                voiceToggle.textContent = 'ðŸ”´ ElevenLabs Agent ACTIVE';
                voiceStatus.classList.remove('hidden');
                textInput.disabled = true;
                sendBtn.disabled = true;

                // 2. Demonstration Logic: Simulate Agent response
                setTimeout(() => {
                    renderMessage("ElevenLabs Agent initialized. Speak your order now!", "ai");
                }, 500);

                /*
                // --- ðŸ›‘ REAL INTEGRATION CODE (If SDK was included) ---
                if (window.ElevenLabsAgent) {
                    elevenLabsAgent = window.ElevenLabsAgent.initialize({
                        apiKey: 'YOUR_ELEVENLABS_API_KEY', // Must be a PAT or dedicated API key
                        agentId: 'YOUR_AGENT_ID',          // ID of the agent configured with your menu logic
                        // Handle text responses from the AI
                        onMessage: (msg) => {
                            renderMessage(msg.text, 'ai');
                        },
                        // Handle the agent calling the 'checkout' tool (The crucial link!)
                        onToolCall: (tool) => { 
                            if (tool.name === 'finalize_order') { 
                                // The AI Agent provides the complete, structured JSON order
                                const finalOrder = JSON.parse(tool.arguments.order_data); 
                                // Call our local function to handle receipt/DB logging
                                renderMessage('The AI Agent has finalized your order. Scan the QR code below to save it.', 'receipt', finalOrder);
                            }
                        }
                    });
                    elevenLabsAgent.startListening();
                }
                */

            } else {
                voiceToggle.textContent = 'ðŸŽ¤ Activate ElevenLabs Agent';
                voiceStatus.classList.add('hidden');
                textInput.disabled = false;
                sendBtn.disabled = false;

                // if (elevenLabsAgent) elevenLabsAgent.stopListening();
            }
        });


        // --- 2. Barista View Functions ---
        
        function updateOrderStatus(id, newStatus) {
            const orderIndex = orders.findIndex(o => o.id === id);
            if (orderIndex !== -1) {
                orders[orderIndex].status = newStatus;
                saveOrders();
                renderBaristaView();
                
                if (newStatus === 'Completed') {
                    let completedIds = JSON.parse(sessionStorage.getItem('completedOrderIds')) || [];
                    completedIds.push(id);
                    sessionStorage.setItem('completedOrderIds', JSON.stringify(completedIds));
                }
            }
        }

        function renderBaristaView() {
            orderQueue.innerHTML = '';
            const activeOrders = orders.filter(o => o.status !== 'Completed');

            if (activeOrders.length === 0) {
                noOrdersMessage.classList.remove('hidden');
                orderQueue.appendChild(noOrdersMessage);
                return;
            } else {
                noOrdersMessage.classList.add('hidden');
            }

            activeOrders.forEach(order => {
                const ticketDiv = document.createElement('div');
                ticketDiv.classList.add('order-ticket');
                
                const statusClass = order.status === 'In Progress' ? 'status-in-progress' : 'status-pending';

                let detailsHTML = `<ul class="ticket-details">`;
                order.items.forEach(item => {
                    let modsSummary = [
                        item.mods.milk.toUpperCase(),
                        item.mods.shots > 1 ? 'EXTRA SHOT' : null,
                        item.mods.matcha > 0 ? 'EXTRA MATCHA' : null,
                        item.mods.syrup !== MODIFIERS.syrup.default ? item.mods.syrup.toUpperCase() : null,
                        item.mods.sweetness !== MODIFIERS.sweetness.default ? item.mods.sweetness.toUpperCase() : null,
                        item.mods.ice !== MODIFIERS.ice.default ? item.mods.ice.toUpperCase() : null,
                    ].filter(Boolean).join(', ');

                    detailsHTML += `<li>${item.mods.size.toUpperCase()} ${item.mods.temp.toUpperCase()} <strong>${item.name.toUpperCase()}</strong> (${modsSummary})</li>`;
                });
                detailsHTML += `</ul>`;

                let actionsHTML = '';
                if (order.status === 'Pending') {
                    actionsHTML = `<button onclick="updateOrderStatus('${order.id}', 'In Progress')">Start</button>`;
                } else if (order.status === 'In Progress') {
                    actionsHTML = `<button onclick="updateOrderStatus('${order.id}', 'Completed')">Complete</button>`;
                }


                ticketDiv.innerHTML = `
                    <div class="ticket-header">
                        <span>Ticket: **${order.id}**</span>
                        <span class="status-tag ${statusClass}">${order.status.toUpperCase()}</span>
                    </div>
                    ${detailsHTML}
                    <div class="ticket-actions">${actionsHTML}</div>
                `;

                orderQueue.appendChild(ticketDiv);
            });
        }
        
        function checkCompletedOrdersAndNotify() {
            let completedIds = JSON.parse(sessionStorage.getItem('completedOrderIds')) || [];
            
            if (completedIds.length > 0) {
                const notificationMessage = `ðŸŽ‰ Your order #${completedIds.join(', #')} is ready for pickup at the counter!`;
                renderMessage(notificationMessage, 'notification');
                
                sessionStorage.removeItem('completedOrderIds');
            }
        }


        // --- 3. Owner View Functions ---

        function renderOwnerView() {
            const allItems = orders.flatMap(order => order.items.map(item => ({
                name: item.name,
                price: parseFloat(item.price)
            })));

            const totalOrders = orders.length;
            const totalRevenue = allItems.reduce((sum, item) => sum + item.price, 0);
            const aov = totalOrders > 0 ? (totalRevenue / totalOrders) : 0;
            
            const itemCounts = allItems.reduce((counts, item) => {
                counts[item.name] = (counts[item.name] || 0) + 1;
                return counts;
            }, {});

            const sortedItems = Object.entries(itemCounts)
                .sort(([, countA], [, countB]) => countB - countA)
                .map(([name, count]) => ({ name, count }));

            const topItem = sortedItems.length > 0 ? sortedItems[0].name.toUpperCase() : 'N/A';

            document.getElementById('metric-total-orders').textContent = totalOrders;
            document.getElementById('metric-aov').textContent = `$${aov.toFixed(2)}`;
            document.getElementById('metric-revenue').textContent = `$${totalRevenue.toFixed(2)}`;
            document.getElementById('metric-top-item').textContent = topItem;

            const topSellingList = document.getElementById('top-selling-list');
            topSellingList.innerHTML = '';
            sortedItems.slice(0, 3).forEach(item => {
                const li = document.createElement('li');
                li.textContent = `${item.name.toUpperCase()} (${item.count} sold)`;
                topSellingList.appendChild(li);
            });
        }

        // --- Persistence (Local Storage as lightweight DB) ---
        function saveOrders() {
            localStorage.setItem('vibeCoffeeOrders', JSON.stringify(orders));
        }

        // --- Tab Logic ---
        function handleTabSwitch(viewName) {
            document.querySelectorAll('.view-section').forEach(section => {
                section.classList.add('hidden');
            });
            document.getElementById(`${viewName}-view`).classList.remove('hidden');

            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`.tab-button[data-view="${viewName}"]`).classList.add('active');

            if (viewName === 'barista') {
                renderBaristaView();
            } else if (viewName === 'owner') {
                renderOwnerView();
            } else if (viewName === 'customer') {
                checkCompletedOrdersAndNotify();
            }
        }

        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', (e) => {
                handleTabSwitch(e.target.dataset.view);
            });
        });

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            renderBaristaView();
            renderOwnerView();
            checkCompletedOrdersAndNotify();
        });
        
    </script>
</body>
</html>
